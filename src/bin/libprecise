#!/bin/sh
#
# libprecise: a near exact-match reverse library use checker for LFS systems; for regex-based, checks, see libcheck
#
# Copyright 2021 K. Eugene Carlson  Tsukuba, Japan
# All rights reserved.
#
# Redistribution and use of this script, with or without modification, is
# permitted provided that the following conditions are met:
#
# 1. Redistributions of this script must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
#
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR IMPLIED
#  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
#  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO
#  EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
#  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
#  OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
#  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
#  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# Checking for information about a particular library.

DATA=/var/yalpack/pkgdata
PKGLIBS=$DATA/PKG-LIBS
PKGDEPS=$DATA/PKG-DEPS
# If BINDEPS is changed, alter the "cut" instructions below accordingly.
BINDEPS=/var/yalpack/BIN-DEPS

y="$1[.]"

echo
echo Checking for information about the library "$1". If the intended library does not exist in the form "$1".*, results will be incomplete or inaccurate.
echo

for PKG in "$PKGLIBS"/*
do
	if [ -f "$PKG/libs" ]; then
		x=$(grep "$y" "$PKG/libs")
		PKG=$(basename "$PKG")
		[ -n "$x" ] && echo "$1" appears to have been installed by the "$PKG" package.
	fi
done

echo
echo The following packages use this library:
grep "$y" "$PKGDEPS"/*/* | cut -d'/' -f6- | cut -d'/' -f-1 | uniq

echo
echo The following binaries use this library:
grep "$y" $BINDEPS/*/* | cut -d'/' -f5- | cut -d'/' -f-1 | uniq
echo
